<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Test - Chimeo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .checklist {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .checklist h3 {
            margin-top: 0;
        }
        .checklist ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .checklist li {
            margin: 5px 0;
        }
        .checklist .pass {
            color: #28a745;
        }
        .checklist .fail {
            color: #dc3545;
        }
        .checklist .warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Push Notification Test</h1>
        <p>This page will help diagnose push notification issues in your Chimeo app.</p>
        
        <div id="status" class="status info">Initializing...</div>
        
        <div class="checklist">
            <h3>System Requirements Checklist</h3>
            <ul id="checklist">
                <li id="check-https">Checking HTTPS requirement...</li>
                <li id="check-service-worker">Checking Service Worker support...</li>
                <li id="check-push-manager">Checking Push Manager support...</li>
                <li id="check-notification">Checking Notification API...</li>
                <li id="check-firebase">Checking Firebase Messaging...</li>
                <li id="check-permission">Checking notification permission...</li>
            </ul>
        </div>
        
        <div>
            <button id="requestPermission" onclick="requestPermission()">Request Notification Permission</button>
            <button id="testNotification" onclick="testNotification()" disabled>Test Local Notification</button>
            <button id="testFCM" onclick="testFCM()" disabled>Test FCM Token</button>
            <button id="clearLog" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js'
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js'
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js'
        import { getMessaging, getToken, onMessage, isSupported } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging.js'

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA96jGLzCUMVe9FHHS1lQ8vdbi8DFhAs6o",
            authDomain: "chimeo-96dfc.firebaseapp.com",
            databaseURL: "https://chimeo-96dfc-default-rtdb.firebaseio.com",
            projectId: "chimeo-96dfc",
            storageBucket: "chimeo-96dfc.firebasestorage.app",
            messagingSenderId: "280448574070",
            appId: "1:280448574070:web:9cb5298f2f0b10770a7557",
            measurementId: "G-GCSQ5KSTF0"
        }

        const VAPID_KEY = "BKj330egH_Do8wrOuLBqR8QqN00tMzJOTxU2XgqpPw2iH8cIvl-m73gYlkDMOwUiyCzr1puqZ_Gza8uEI3uxh9Q"

        let messaging = null
        let fcmToken = null

        function addLog(message) {
            const log = document.getElementById('log')
            log.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n'
            log.scrollTop = log.scrollHeight
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status')
            status.textContent = message
            status.className = `status ${type}`
        }

        function updateChecklistItem(id, status, message) {
            const item = document.getElementById(id)
            item.className = status
            item.textContent = message
        }

        function clearLog() {
            document.getElementById('log').textContent = ''
        }

        async function runDiagnostics() {
            addLog('üîç Starting push notification diagnostics...')
            
            // Check HTTPS
            if (window.isSecureContext) {
                updateChecklistItem('check-https', 'pass', '‚úÖ HTTPS: Secure context detected')
                addLog('‚úÖ Running in secure context (HTTPS)')
            } else {
                updateChecklistItem('check-https', 'fail', '‚ùå HTTPS: Not in secure context')
                addLog('‚ùå Not running in secure context - HTTPS required for push notifications')
            }

            // Check Service Worker support
            if ('serviceWorker' in navigator) {
                updateChecklistItem('check-service-worker', 'pass', '‚úÖ Service Worker: Supported')
                addLog('‚úÖ Service Worker API is supported')
            } else {
                updateChecklistItem('check-service-worker', 'fail', '‚ùå Service Worker: Not supported')
                addLog('‚ùå Service Worker API not supported')
            }

            // Check Push Manager support
            if ('PushManager' in window) {
                updateChecklistItem('check-push-manager', 'pass', '‚úÖ Push Manager: Supported')
                addLog('‚úÖ Push Manager API is supported')
            } else {
                updateChecklistItem('check-push-manager', 'fail', '‚ùå Push Manager: Not supported')
                addLog('‚ùå Push Manager API not supported')
            }

            // Check Notification API
            if ('Notification' in window) {
                updateChecklistItem('check-notification', 'pass', '‚úÖ Notification API: Supported')
                addLog('‚úÖ Notification API is supported')
            } else {
                updateChecklistItem('check-notification', 'fail', '‚ùå Notification API: Not supported')
                addLog('‚ùå Notification API not supported')
            }

            // Check Firebase Messaging
            try {
                const app = initializeApp(firebaseConfig)
                addLog('‚úÖ Firebase app initialized')
                
                const messagingSupported = await isSupported()
                if (messagingSupported) {
                    updateChecklistItem('check-firebase', 'pass', '‚úÖ Firebase Messaging: Supported')
                    addLog('‚úÖ Firebase Messaging is supported')
                    
                    // Initialize messaging
                    messaging = getMessaging(app)
                    addLog('‚úÖ Firebase Messaging instance created')
                } else {
                    updateChecklistItem('check-firebase', 'fail', '‚ùå Firebase Messaging: Not supported')
                    addLog('‚ùå Firebase Messaging not supported in this environment')
                }
            } catch (error) {
                updateChecklistItem('check-firebase', 'fail', '‚ùå Firebase Messaging: Error')
                addLog('‚ùå Firebase Messaging error: ' + error.message)
            }

            // Check notification permission
            if ('Notification' in window) {
                const permission = Notification.permission
                if (permission === 'granted') {
                    updateChecklistItem('check-permission', 'pass', '‚úÖ Permission: Granted')
                    addLog('‚úÖ Notification permission is granted')
                    document.getElementById('testNotification').disabled = false
                } else if (permission === 'denied') {
                    updateChecklistItem('check-permission', 'fail', '‚ùå Permission: Denied')
                    addLog('‚ùå Notification permission is denied')
                } else {
                    updateChecklistItem('check-permission', 'warning', '‚ö†Ô∏è Permission: Not requested')
                    addLog('‚ö†Ô∏è Notification permission not yet requested')
                }
            }

            // Check service worker registration
            try {
                const registration = await navigator.serviceWorker.getRegistration('/firebase-messaging-sw.js')
                if (registration) {
                    addLog('‚úÖ Service worker is registered: ' + registration.scope)
                } else {
                    addLog('‚ö†Ô∏è Service worker not found, attempting to register...')
                    try {
                        const newRegistration = await navigator.serviceWorker.register('/firebase-messaging-sw.js')
                        addLog('‚úÖ Service worker registered successfully: ' + newRegistration.scope)
                    } catch (swError) {
                        addLog('‚ùå Failed to register service worker: ' + swError.message)
                    }
                }
            } catch (error) {
                addLog('‚ùå Service worker check failed: ' + error.message)
            }

            // Overall status
            const allChecks = document.querySelectorAll('#checklist li')
            const passedChecks = document.querySelectorAll('#checklist li.pass').length
            const totalChecks = allChecks.length

            if (passedChecks === totalChecks) {
                updateStatus('All checks passed! Push notifications should work.', 'success')
                addLog('üéâ All diagnostic checks passed!')
            } else if (passedChecks > totalChecks / 2) {
                updateStatus('Most checks passed. Some issues may prevent notifications.', 'warning')
                addLog('‚ö†Ô∏è Some diagnostic checks failed - notifications may not work properly')
            } else {
                updateStatus('Multiple issues found. Push notifications likely won\'t work.', 'error')
                addLog('‚ùå Multiple diagnostic checks failed - notifications will not work')
            }
        }

        async function requestPermission() {
            addLog('üîî Requesting notification permission...')
            
            if (!('Notification' in window)) {
                addLog('‚ùå Notifications not supported in this browser')
                return
            }

            try {
                const permission = await Notification.requestPermission()
                addLog('üì± Permission result: ' + permission)
                
                if (permission === 'granted') {
                    updateChecklistItem('check-permission', 'pass', '‚úÖ Permission: Granted')
                    document.getElementById('testNotification').disabled = false
                    addLog('‚úÖ Notification permission granted!')
                    
                    // Try to get FCM token if messaging is available
                    if (messaging) {
                        try {
                            fcmToken = await getToken(messaging, { vapidKey: VAPID_KEY })
                            if (fcmToken) {
                                addLog('‚úÖ FCM Token obtained: ' + fcmToken.substring(0, 50) + '...')
                                document.getElementById('testFCM').disabled = false
                            } else {
                                addLog('‚ùå No FCM token received')
                            }
                        } catch (tokenError) {
                            addLog('‚ùå FCM token error: ' + tokenError.message)
                        }
                    }
                } else {
                    updateChecklistItem('check-permission', 'fail', '‚ùå Permission: Denied')
                    addLog('‚ùå Notification permission denied')
                }
            } catch (error) {
                addLog('‚ùå Permission request error: ' + error.message)
            }
        }

        async function testNotification() {
            addLog('üîî Testing local notification...')
            
            try {
                const notification = new Notification('Test Notification', {
                    body: 'This is a test notification from Chimeo',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2MzY2RjEiLz4KPHRleHQgeD0iOTYiIHk9IjExMCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkM8L3RleHQ+Cjwvc3ZnPgo=',
                    tag: 'test-notification'
                })
                
                addLog('‚úÖ Test notification created successfully')
                
                notification.onclick = () => {
                    addLog('üîî Test notification clicked')
                    notification.close()
                }
                
                notification.onclose = () => {
                    addLog('üîî Test notification closed')
                }
                
            } catch (error) {
                addLog('‚ùå Test notification failed: ' + error.message)
            }
        }

        async function testFCM() {
            addLog('üîî Testing FCM token...')
            
            if (!messaging) {
                addLog('‚ùå Firebase Messaging not initialized')
                return
            }

            if (!fcmToken) {
                try {
                    fcmToken = await getToken(messaging, { vapidKey: VAPID_KEY })
                    if (fcmToken) {
                        addLog('‚úÖ FCM Token: ' + fcmToken)
                    } else {
                        addLog('‚ùå No FCM token received')
                    }
                } catch (error) {
                    addLog('‚ùå FCM token error: ' + error.message)
                }
            } else {
                addLog('‚úÖ FCM Token (cached): ' + fcmToken)
            }

            // Test message listener
            if (messaging) {
                try {
                    onMessage(messaging, (payload) => {
                        addLog('üì± FCM message received: ' + JSON.stringify(payload))
                    })
                    addLog('‚úÖ FCM message listener registered')
                } catch (error) {
                    addLog('‚ùå FCM message listener error: ' + error.message)
                }
            }
        }

        // Make functions globally available
        window.requestPermission = requestPermission
        window.testNotification = testNotification
        window.testFCM = testFCM
        window.clearLog = clearLog

        // Run diagnostics on page load
        runDiagnostics()
    </script>
</body>
</html>
